// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORIGINAL ARCHITECTURE (from commit c1e9958)
// ============================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contractorsCreated    Contractor[]   @relation("ContractorCreator")
  projects              Project[]
  generatedCOIsAssigned GeneratedCOI[] @relation("AssignedAdmin")
  auditLogs             AuditLog[]
  refreshTokens         RefreshToken[]

  @@map("users")
}

// Separate table for refresh tokens - prevents timing attacks and DoS
// Uses selector/verifier pattern for O(1) lookup with single bcrypt comparison
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  selector  String   @unique // Unique constraint creates index automatically
  verifier  String // Hashed with bcrypt (for secure comparison)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId, expiresAt]) // Composite index for user-specific and cleanup operations
  @@map("refresh_tokens")
}

enum UserRole {
  SUPER_ADMIN // Full access, sees everything, no filtering
  ADMIN // Assistant admin, filtered by assigned_admin_email
  MANAGER
  USER
  CONTRACTOR
  SUBCONTRACTOR
  BROKER
}

model Contractor {
  id              String           @id @default(uuid())
  name            String
  email           String           @unique
  phone           String?
  company         String?
  contractorType  ContractorType   @default(SUBCONTRACTOR)
  status          ContractorStatus @default(PENDING)
  insuranceStatus InsuranceStatus  @default(PENDING)
  trades          String[]         @default([]) // Array of trade specialties (e.g., "Electrical", "Plumbing", "HVAC")

  // Broker information
  brokerName    String?
  brokerEmail   String?
  brokerPhone   String?
  brokerCompany String?
  brokerType    BrokerType?

  // Per-policy broker fields
  brokerGlName        String?
  brokerGlEmail       String?
  brokerGlPhone       String?
  brokerAutoName      String?
  brokerAutoEmail     String?
  brokerAutoPhone     String?
  brokerUmbrellaName  String?
  brokerUmbrellaEmail String?
  brokerUmbrellaPhone String?
  brokerWcName        String?
  brokerWcEmail       String?
  brokerWcPhone       String?

  // Admin assignment (for assistant admin filtering)
  assignedAdminEmail String?

  createdById String
  createdBy   User     @relation("ContractorCreator", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  insuranceDocuments    InsuranceDocument[]
  projectContractors    ProjectContractor[]
  generatedCOIs         GeneratedCOI[]
  projectSubcontractors ProjectSubcontractor[]

  @@index([trades])
  @@map("contractors")
}

enum ContractorType {
  GENERAL_CONTRACTOR
  SUBCONTRACTOR
}

enum BrokerType {
  GLOBAL
  PER_POLICY
}

enum ContractorStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum InsuranceStatus {
  COMPLIANT
  NON_COMPLIANT
  PENDING
  EXPIRED
}

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  address     String? // Project location/address
  startDate   DateTime
  endDate     DateTime?
  status      ProjectStatus @default(PLANNING)
  gcName      String?
  location    String?

  // ACRIS Data Fields
  borough            String?
  block              String?
  lot                String?
  buildingHeight     String?
  structureType      String?
  entity             String?
  additionalInsureds String?
  contactPerson      String?
  contactEmail       String?
  contactPhone       String?

  // Admin assignment (for assistant admin filtering)
  assignedAdminEmail String?

  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projectContractors    ProjectContractor[]
  projectSubcontractors ProjectSubcontractor[]
  generatedCOIs         GeneratedCOI[]
  programs              ProjectProgram[]

  @@map("projects")
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

model ProjectContractor {
  id           String     @id @default(uuid())
  projectId    String
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  contractorId String
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  role         String?
  assignedAt   DateTime   @default(now())

  @@unique([projectId, contractorId])
  @@map("project_contractors")
}

// Junction table for Project <-> Subcontractor
model ProjectSubcontractor {
  id              String     @id @default(uuid())
  projectId       String
  project         Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  subcontractorId String
  subcontractor   Contractor @relation(fields: [subcontractorId], references: [id], onDelete: Cascade)
  role            String?
  assignedAt      DateTime   @default(now())

  @@unique([projectId, subcontractorId])
  @@map("project_subcontractors")
}

// Generated COI (Certificate of Insurance) - Core of the workflow
// Generated COI (Certificate of Insurance) Model
model GeneratedCOI {
  id              String     @id @default(uuid())
  projectId       String
  project         Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  subcontractorId String
  subcontractor   Contractor @relation(fields: [subcontractorId], references: [id], onDelete: Cascade)

  projectName       String?
  gcName            String?
  subcontractorName String?

  status COIStatus @default(AWAITING_BROKER_INFO)

  // Broker information
  brokerName    String?
  brokerEmail   String?
  brokerPhone   String?
  brokerCompany String?

  // Per-policy broker info
  brokerGlName        String?
  brokerGlEmail       String?
  brokerGlPhone       String?
  brokerAutoName      String?
  brokerAutoEmail     String?
  brokerAutoPhone     String?
  brokerUmbrellaName  String?
  brokerUmbrellaEmail String?
  brokerUmbrellaPhone String?
  brokerWcName        String?
  brokerWcEmail       String?
  brokerWcPhone       String?

  // Policy documents
  glPolicyUrl       String?
  umbrellaPolicyUrl String?
  autoPolicyUrl     String?
  wcPolicyUrl       String?

  // Broker signatures
  glBrokerSignatureUrl       String?
  umbrellaBrokerSignatureUrl String?
  autoBrokerSignatureUrl     String?
  wcBrokerSignatureUrl       String?

  // Policy details
  glExpirationDate       DateTime?
  umbrellaExpirationDate DateTime?
  autoExpirationDate     DateTime?
  wcExpirationDate       DateTime?

  // First COI tracking
  firstCOIUploaded Boolean @default(false)
  firstCOIUrl      String?

  // Hold Harmless Agreement
  holdHarmlessDocumentUrl String?
  holdHarmlessUploadedAt  DateTime?
  holdHarmlessStatus      HoldHarmlessStatus @default(PENDING_GENERATION)

  // Admin review
  assignedAdminEmail String?
  assignedAdmin      User?   @relation("AssignedAdmin", fields: [assignedAdminEmail], references: [email], onDelete: SetNull)
  deficiencyNotes    String?
  rejectionReason    String?

  // Timestamps
  uploadedForReviewDate   DateTime?
  brokerVerifiedAtRenewal Boolean   @default(false)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  reminders    ExpirationReminder[]
  holdHarmless HoldHarmless?

  @@index([projectId])
  @@index([subcontractorId])
  @@index([status])
  @@index([assignedAdminEmail])
  @@index([glExpirationDate])
  @@index([umbrellaExpirationDate])
  @@map("generated_cois")
}

enum COIStatus {
  AWAITING_BROKER_INFO
  AWAITING_BROKER_UPLOAD
  AWAITING_BROKER_SIGNATURE
  AWAITING_ADMIN_REVIEW
  ACTIVE
  DEFICIENCY_PENDING
  EXPIRED
}

// Insurance Document Model
model InsuranceDocument {
  id             String         @id @default(uuid())
  contractorId   String
  contractor     Contractor     @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  type           InsuranceType
  provider       String
  policyNumber   String
  coverageAmount Float
  effectiveDate  DateTime
  expirationDate DateTime
  status         DocumentStatus @default(PENDING)
  fileUrl        String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([contractorId])
  @@index([status])
  @@index([expirationDate])
  @@map("insurance_documents")
}

enum InsuranceType {
  GENERAL_LIABILITY
  WORKERS_COMPENSATION
  AUTO_LIABILITY
  PROFESSIONAL_LIABILITY
  UMBRELLA
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

// Audit Log Model for security and compliance tracking
model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, VIEW, etc.
  resource   String // USER, CONTRACTOR, PROJECT, INSURANCE_DOCUMENT, etc.
  resourceId String? // ID of the affected resource
  changes    Json? // JSON object with before/after values for updates
  metadata   Json? // Additional context (e.g., request headers, IP, etc.)
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  @@index([userId])
  @@index([resource, resourceId])
  @@index([timestamp])
  @@index([action])
  @@map("audit_logs")
}

// ============================================
// NEW FEATURES: Reminders, Programs, Hold Harmless
// ============================================

// Expiration Reminder System (30d→14d→7d→2d→every 2d)
model ExpirationReminder {
  id               String       @id @default(uuid())
  coiId            String
  coi              GeneratedCOI @relation(fields: [coiId], references: [id], onDelete: Cascade)
  policyType       String // GL, UMBRELLA, AUTO, WC
  expirationDate   DateTime
  daysBeforeExpiry Int // 30, 14, 7, 2
  reminderType     ReminderType
  sentAt           DateTime     @default(now())
  sentTo           String[] // Email addresses
  emailSubject     String?
  emailBody        String?      @db.Text
  acknowledged     Boolean      @default(false)
  acknowledgedAt   DateTime?
  acknowledgedBy   String?
  createdAt        DateTime     @default(now())

  @@index([coiId])
  @@index([expirationDate])
  @@index([daysBeforeExpiry])
  @@index([sentAt])
  @@map("expiration_reminders")
}

enum ReminderType {
  DAYS_30 // 30 days before expiration
  DAYS_14 // 14 days before expiration
  DAYS_7 // 7 days before expiration
  DAYS_2 // 2 days before expiration
  EVERY_2_DAYS // Every 2 days after expiration
  EXPIRED // Immediate notification when expired
}

enum HoldHarmlessStatus {
  PENDING_GENERATION // Waiting for COI approval to trigger generation
  PENDING_SUB_SIGNATURE // Sent to subcontractor, awaiting signature
  PENDING_GC_SIGNATURE // Sub signed, sent to GC, awaiting signature
  COMPLETED // Both parties signed
  REJECTED
  EXPIRED
}

// Hold Harmless Agreement Tracking with Signature Workflow
model HoldHarmless {
  id        String       @id @default(uuid())
  coiId     String       @unique
  coi       GeneratedCOI @relation(fields: [coiId], references: [id], onDelete: Cascade)
  programId String? // Reference to program template

  // Document URLs
  templateUrl     String? // Original template from program
  generatedDocUrl String? // Auto-generated document with filled data
  finalDocUrl     String? // Final signed document

  status HoldHarmlessStatus @default(PENDING_GENERATION)

  // Auto-filled data from system
  projectAddress     String?
  gcName             String?
  gcEmail            String?
  ownersEntity       String?
  additionalInsureds String[] // List of additional insureds
  subcontractorName  String?
  subcontractorEmail String?

  // Agreement details
  agreementType  String? // "Indemnification", "Waiver", "Combined"
  effectiveDate  DateTime?
  expirationDate DateTime?

  // Signature tracking - Subcontractor
  subSignatureUrl        String? // URL to signature image/data
  subSignedAt            DateTime?
  subSignedBy            String? // Email of person who signed
  subSignatureToken      String? // Unique token for signature link
  subSignatureLinkSentAt DateTime?

  // Signature tracking - GC
  gcSignatureUrl        String? // URL to signature image/data
  gcSignedAt            DateTime?
  gcSignedBy            String? // Email of person who signed
  gcSignatureToken      String? // Unique token for signature link
  gcSignatureLinkSentAt DateTime?

  // Notifications
  notificationsSent String[] // Emails of parties notified
  notifiedAt        DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  generatedAt DateTime? // When auto-generated after COI approval
  completedAt DateTime? // When both signatures collected

  @@index([coiId])
  @@index([status])
  @@index([subSignatureToken])
  @@index([gcSignatureToken])
  @@map("hold_harmless")
}

// Insurance Program Templates
model InsuranceProgram {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text
  isTemplate  Boolean @default(true)

  // Requirements by policy type
  glMinimum       Float? // General Liability minimum coverage
  wcMinimum       Float? // Workers Comp minimum
  autoMinimum     Float? // Auto Liability minimum
  umbrellaMinimum Float? // Umbrella minimum

  // Additional requirements
  requiresHoldHarmless      Boolean @default(false)
  holdHarmlessTemplateUrl   String? // URL to hold harmless template document
  requiresAdditionalInsured Boolean @default(true)
  requiresWaiverSubrogation Boolean @default(true)

  // Tier-based requirements (JSON for flexibility)
  tierRequirements  Json? // { "tier1": {...}, "tier2": {...} }
  tradeRequirements Json? // { "electrical": {...}, "plumbing": {...} }

  // Workflow settings
  autoApprovalRules Json? // Conditions for auto-approval

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projects ProjectProgram[]

  @@index([name])
  @@index([isTemplate])
  @@map("insurance_programs")
}

// Junction table for Project <-> InsuranceProgram
model ProjectProgram {
  id         String           @id @default(uuid())
  projectId  String
  project    Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  programId  String
  program    InsuranceProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  assignedAt DateTime         @default(now())
  assignedBy String?

  // Override program settings for this project
  customRequirements Json?

  @@unique([projectId, programId])
  @@map("project_programs")
}
