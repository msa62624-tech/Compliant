# Netlify Configuration for Compliant Platform (Full-Stack)
# Documentation: https://docs.netlify.com/configure-builds/file-based-configuration/

# ==============================================================================
# DEPLOYMENT MODE - CHOOSE ONE:
# ==============================================================================
# MODE 1: Full-Stack (Frontend + Backend on Netlify Functions)
# - Uncomment the [build] section below with "Full-Stack Build"
# - Backend runs as Netlify Functions with 10s timeout (free tier)
# - Best for: Simple APIs, low traffic, serverless architecture
#
# MODE 2: Frontend Only (Backend hosted elsewhere)
# - Use the commented "Frontend Only Build" section
# - Backend hosted on Render, Railway, Fly.io, etc.
# - Best for: Complex APIs, long-running operations, high traffic
# ==============================================================================

# ------------------------------------------------------------------------------
# MODE 1: Full-Stack Build (Frontend + Backend on Netlify)
# ------------------------------------------------------------------------------
[build]
  base = "packages/frontend"
  # Build shared package, backend, and frontend from frontend directory
  # Install root dependencies first for Netlify Functions (serverless-http)
  command = "cd ../../ && pnpm install && cd packages/shared && pnpm build && cd ../backend && pnpm build && cd ../frontend && pnpm build"
  publish = ".next"
  functions = "../../netlify/functions"

# ------------------------------------------------------------------------------
# MODE 2: Frontend Only Build (Uncomment to use)
# ------------------------------------------------------------------------------
# [build]
#   base = "packages/frontend"
#   command = "cd ../shared && pnpm install && pnpm build && cd ../frontend && pnpm install && pnpm build"
#   publish = "packages/frontend/.next"

[build.environment]
  # Node.js version
  NODE_VERSION = "20.0.0"
  
  # PNPM version
  PNPM_VERSION = "8.15.0"
  
  # Set NODE_ENV to production for secure cookies
  NODE_ENV = "production"
  
  # Disable opencollective postinstall script (prevents @nuxt/opencollective error)
  OPENCOLLECTIVE_HIDE = "1"
  DISABLE_OPENCOLLECTIVE = "true"
  
  # Frontend URL for CORS
  FRONTEND_URL = "https://compliantteam.netlify.app"
  
  # IMPORTANT: Set these sensitive environment variables in Netlify Dashboard UI
  # (Site settings -> Build & deploy -> Environment variables)
  # DO NOT commit secrets to the repository!
  #
  # Required variables to set in Netlify Dashboard:
  # 1. DATABASE_URL - PostgreSQL connection string
  #    Format: postgresql://username:password@hostname:5432/database_name?schema=public
  #    Get from: Supabase, Neon, Railway, Render, or your own PostgreSQL server
  #
  # 2. JWT_SECRET - JWT signing secret (minimum 32 characters)
  #    Generate with: openssl rand -base64 48
  #
  # 3. JWT_REFRESH_SECRET - Refresh token secret (minimum 32 characters, different from JWT_SECRET)
  #    Generate with: openssl rand -base64 48
  #
  # For Frontend Only Mode (MODE 2):
  # - NEXT_PUBLIC_API_URL = "https://your-backend-api.com/api"

# ------------------------------------------------------------------------------
# Netlify Functions Configuration
# ------------------------------------------------------------------------------
[functions]
  # Use esbuild bundler with external modules to reduce size while avoiding dependency analysis issues
  node_bundler = "esbuild"
  
  # Mark packages as external to prevent bundler from analyzing their optional dependencies
  # and to ensure runtime dependencies are available from node_modules
  external_node_modules = ["@nestjs/core", "opencollective", "serverless-http", "cookie-parser"]
  
  # Include backend build, shared build, and root node_modules with NestJS dependencies
  # Note: NestJS dependencies installed at root level for Netlify function access
  included_files = [
    "packages/backend/dist/**",
    "packages/shared/dist/**",
    "../../node_modules/@compliant/**",
    "../../node_modules/@nestjs/**",
    "../../node_modules/@prisma/**",
    "../../node_modules/reflect-metadata/**",
    "../../node_modules/rxjs/**",
    "../../node_modules/class-transformer/**",
    "../../node_modules/class-validator/**",
    "../../node_modules/consola/**",
    "../../node_modules/serverless-http/**",
    "../../node_modules/cookie-parser/**",
    "../../node_modules/opencollective/**",
    "../../node_modules/chalk/**",
    "../../node_modules/inquirer/**",
    "../../node_modules/minimist/**",
    "../../node_modules/node-fetch/**",
    "../../node_modules/babel-polyfill/**",
    "../../node_modules/opn/**"
  ]

# ------------------------------------------------------------------------------
# Redirects and Rewrites
# ------------------------------------------------------------------------------

# Redirect API calls to Netlify Functions (for MODE 1 - Full-Stack)
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200
  force = false

# Handle Next.js dynamic routes
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# ------------------------------------------------------------------------------
# Security Headers
# ------------------------------------------------------------------------------
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"

# ------------------------------------------------------------------------------
# Caching Headers
# ------------------------------------------------------------------------------
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# ------------------------------------------------------------------------------
# Context-Specific Builds
# ------------------------------------------------------------------------------

# Deploy previews (PR builds)
[context.deploy-preview]
  command = "cd ../../ && pnpm install && cd packages/shared && pnpm build && cd ../backend && pnpm build && cd ../frontend && pnpm build"

# Branch deploys
[context.branch-deploy]
  command = "cd ../../ && pnpm install && cd packages/shared && pnpm build && cd ../backend && pnpm build && cd ../frontend && pnpm build"

# Production context
[context.production]
  command = "cd ../../ && pnpm install && cd packages/shared && pnpm build && cd ../backend && pnpm build && cd ../frontend && pnpm build"

# ------------------------------------------------------------------------------
# Optional Plugins (uncomment to enable)
# ------------------------------------------------------------------------------
# [[plugins]]
#   package = "netlify-plugin-cache-nextjs"
#
# [[plugins]]
#   package = "@netlify/plugin-lighthouse"

