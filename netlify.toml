# Netlify Configuration for Compliant Platform (Full-Stack)
# Documentation: https://docs.netlify.com/configure-builds/file-based-configuration/

# ==============================================================================
# DEPLOYMENT MODE - CHOOSE ONE:
# ==============================================================================
# MODE 1: Full-Stack (Frontend + Backend on Netlify Functions)
# - Uncomment the [build] section below with "Full-Stack Build"
# - Backend runs as Netlify Functions with 10s timeout (free tier)
# - Best for: Simple APIs, low traffic, serverless architecture
#
# MODE 2: Frontend Only (Backend hosted elsewhere)
# - Use the commented "Frontend Only Build" section
# - Backend hosted on Render, Railway, Fly.io, etc.
# - Best for: Complex APIs, long-running operations, high traffic
# ==============================================================================

# ------------------------------------------------------------------------------
# MODE 1: Full-Stack Build (Frontend + Backend on Netlify)
# ------------------------------------------------------------------------------
[build]
  base = "."
  # Build shared package, backend, and frontend from repository root
  # This ensures Netlify properly detects the Node.js monorepo setup
  command = """
    pnpm install &&
    cd packages/shared && pnpm build &&
    cd ../backend && pnpm build &&
    cd ../frontend && pnpm build
  """
  publish = "packages/frontend/.next"
  functions = "netlify/functions"

# ------------------------------------------------------------------------------
# MODE 2: Frontend Only Build (Uncomment to use)
# ------------------------------------------------------------------------------
# [build]
#   base = "packages/frontend"
#   command = "cd ../shared && pnpm install && pnpm build && cd ../frontend && pnpm install && pnpm build"
#   publish = "packages/frontend/.next"

[build.environment]
  # Node.js version
  NODE_VERSION = "20.0.0"
  
  # PNPM version
  PNPM_VERSION = "8.15.0"
  
  # Important: Set environment variables in Netlify Dashboard UI
  # Site settings -> Build & deploy -> Environment variables
  #
  # For Full-Stack Mode (MODE 1):
  # - NEXT_PUBLIC_API_URL = "/.netlify/functions/api"
  # - DATABASE_URL = "postgresql://..."
  # - JWT_SECRET = "your-secret-min-32-chars"
  # - JWT_REFRESH_SECRET = "your-refresh-secret"
  # - FRONTEND_URL = "https://your-site.netlify.app"
  #
  # For Frontend Only Mode (MODE 2):
  # - NEXT_PUBLIC_API_URL = "https://your-backend-api.com/api"

# ------------------------------------------------------------------------------
# Netlify Functions Configuration
# ------------------------------------------------------------------------------
[functions]
  # Enable esbuild bundler to optimize function size and stay under 250 MB limit
  node_bundler = "esbuild"

# Per-function configuration (applies to all functions via "*")
[functions."*"]
  # Prisma requires special handling - it cannot be bundled by esbuild
  # Include Prisma's generated client and engines (they must be external)
  # Also include NestJS packages for full backend functionality
  included_files = [
    "packages/backend/dist/**",
    "packages/shared/dist/**",
    "node_modules/.prisma/**",
    "node_modules/@prisma/client/**",
    "node_modules/@nestjs/common/**",
    "node_modules/@nestjs/core/**",
    "node_modules/@nestjs/platform-express/**",
    "node_modules/@nestjs/config/**",
    "node_modules/@nestjs/jwt/**",
    "node_modules/@nestjs/passport/**",
    "node_modules/@nestjs/axios/**",
    "node_modules/@nestjs/schedule/**",
    "node_modules/@nestjs/swagger/**",
    "node_modules/@nestjs/terminus/**",
    "node_modules/@nestjs/throttler/**",
    "node_modules/@nestjs/bullmq/**",
    "node_modules/reflect-metadata/**",
    "node_modules/rxjs/**",
    "node_modules/class-transformer/**",
    "node_modules/class-validator/**",
    "node_modules/axios/**",
    "node_modules/bullmq/**",
    "node_modules/cron/**",
    "node_modules/dotenv/**",
    "node_modules/dotenv-expand/**",
    "node_modules/fast-safe-stringify/**",
    "node_modules/file-type/**",
    "node_modules/ioredis/**",
    "node_modules/iterare/**",
    "node_modules/jsonwebtoken/**",
    "node_modules/load-esm/**",
    "node_modules/lodash/**",
    "node_modules/luxon/**",
    "node_modules/passport/**",
    "node_modules/path-to-regexp/**",
    "node_modules/tslib/**",
    "node_modules/uid/**",
    "node_modules/@nuxt/opencollective/**"
  ]
  # External packages that should not be bundled - they need to be available at runtime
  # Prisma needs these as-is for database access
  # NestJS packages must be external for proper dependency injection and decorators
  # Also exclude optional dependencies that are loaded dynamically via require()
  external_node_modules = [
    "@prisma/client",
    ".prisma",
    "@nestjs/common",
    "@nestjs/core",
    "@nestjs/platform-express",
    "@nestjs/config",
    "@nestjs/jwt",
    "@nestjs/passport",
    "@nestjs/axios",
    "@nestjs/schedule",
    "@nestjs/swagger",
    "@nestjs/terminus",
    "@nestjs/throttler",
    "@nestjs/bullmq",
    "@nestjs/microservices",
    "@nestjs/microservices/microservices-module",
    "@nestjs/websockets",
    "@nestjs/websockets/socket-module",
    "@nuxt/opencollective",
    "reflect-metadata",
    "rxjs",
    "class-transformer",
    "class-validator",
    "axios",
    "bullmq",
    "cron",
    "dotenv",
    "dotenv-expand",
    "fast-safe-stringify",
    "file-type",
    "ioredis",
    "iterare",
    "jsonwebtoken",
    "load-esm",
    "lodash",
    "luxon",
    "passport",
    "path-to-regexp",
    "tslib",
    "uid"
  ]

# ------------------------------------------------------------------------------
# Redirects and Rewrites
# ------------------------------------------------------------------------------

# Redirect API calls to Netlify Functions (for MODE 1 - Full-Stack)
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200
  force = false

# Handle Next.js dynamic routes
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# ------------------------------------------------------------------------------
# Security Headers
# ------------------------------------------------------------------------------
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"

# ------------------------------------------------------------------------------
# Caching Headers
# ------------------------------------------------------------------------------
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# ------------------------------------------------------------------------------
# Context-Specific Builds
# ------------------------------------------------------------------------------

# Deploy previews (PR builds)
[context.deploy-preview]
  command = """
    pnpm install &&
    cd packages/shared && pnpm build &&
    cd ../backend && pnpm build &&
    cd ../frontend && pnpm build
  """

# Branch deploys
[context.branch-deploy]
  command = """
    pnpm install &&
    cd packages/shared && pnpm build &&
    cd ../backend && pnpm build &&
    cd ../frontend && pnpm build
  """

# Production context
[context.production]
  command = """
    pnpm install &&
    cd packages/shared && pnpm build &&
    cd ../backend && pnpm build &&
    cd ../frontend && pnpm build
  """

# ------------------------------------------------------------------------------
# Netlify Next.js Plugin (required for Next.js deployment)
# ------------------------------------------------------------------------------
[[plugins]]
  package = "@netlify/plugin-nextjs"

# Netlify Functions Install Plugin (automatically installs function dependencies)
# This ensures dependencies referenced by @nestjs/core (like @nuxt/opencollective) 
# are available during function bundling
[[plugins]]
  package = "@netlify/plugin-functions-install-core"

# ------------------------------------------------------------------------------
# Optional Plugins (uncomment to enable)
# ------------------------------------------------------------------------------
# [[plugins]]
#   package = "netlify-plugin-cache-nextjs"
#
# [[plugins]]
#   package = "@netlify/plugin-lighthouse"

