# Netlify Configuration for Compliant Platform (Full-Stack)
# Documentation: https://docs.netlify.com/configure-builds/file-based-configuration/

# ==============================================================================
# DEPLOYMENT MODE - CHOOSE ONE:
# ==============================================================================
# MODE 1: Full-Stack (Frontend + Backend on Netlify Functions)
# - Uncomment the [build] section below with "Full-Stack Build"
# - Backend runs as Netlify Functions with 10s timeout (free tier)
# - Best for: Simple APIs, low traffic, serverless architecture
#
# MODE 2: Frontend Only (Backend hosted elsewhere)
# - Use the commented "Frontend Only Build" section
# - Backend hosted on Render, Railway, Fly.io, etc.
# - Best for: Complex APIs, long-running operations, high traffic
# ==============================================================================

# ------------------------------------------------------------------------------
# MODE 1: Full-Stack Build (Frontend + Backend on Netlify)
# ------------------------------------------------------------------------------
[build]
  base = "."
  # Build shared package, backend, and frontend from repository root
  # This ensures Netlify properly detects the Node.js monorepo setup
  command = """
    pnpm install &&
    cd packages/shared && pnpm build &&
    cd ../backend && pnpm build &&
    cd ../frontend && pnpm build
  """
  publish = "packages/frontend/.next"
  functions = "netlify/functions"

# ------------------------------------------------------------------------------
# MODE 2: Frontend Only Build (Uncomment to use)
# ------------------------------------------------------------------------------
# [build]
#   base = "packages/frontend"
#   command = "cd ../shared && pnpm install && pnpm build && cd ../frontend && pnpm install && pnpm build"
#   publish = "packages/frontend/.next"

[build.environment]
  # Node.js version
  NODE_VERSION = "20.0.0"
  
  # PNPM version
  PNPM_VERSION = "8.15.0"
  
  # Important: Set environment variables in Netlify Dashboard UI
  # Site settings -> Build & deploy -> Environment variables
  #
  # For Full-Stack Mode (MODE 1):
  # - NEXT_PUBLIC_API_URL = "/.netlify/functions/api"
  # - DATABASE_URL = "postgresql://..."
  # - JWT_SECRET = "your-secret-min-32-chars"
  # - JWT_REFRESH_SECRET = "your-refresh-secret"
  # - FRONTEND_URL = "https://your-site.netlify.app"
  #
  # For Frontend Only Mode (MODE 2):
  # - NEXT_PUBLIC_API_URL = "https://your-backend-api.com/api"

# ------------------------------------------------------------------------------
# Netlify Functions Configuration
# ------------------------------------------------------------------------------
[functions]
  # Enable esbuild bundler to optimize function size and stay under 250 MB limit
  node_bundler = "esbuild"
  # Prisma requires special handling - it cannot be bundled by esbuild
  # Include Prisma's generated client and engines (they must be external)
  included_files = [
    "packages/backend/dist/**",
    "packages/shared/dist/**",
    "node_modules/.prisma/**",
    "node_modules/@prisma/client/**"
  ]
  # External packages that should not be bundled (Prisma needs these as-is)
  # Also exclude NestJS optional dependencies that are loaded dynamically
  external_node_modules = [
    "@prisma/client",
    ".prisma",
    "@nestjs/microservices",
    "@nestjs/microservices/microservices-module",
    "@nestjs/websockets",
    "@nestjs/websockets/socket-module"
  ]

# ------------------------------------------------------------------------------
# Redirects and Rewrites
# ------------------------------------------------------------------------------

# Redirect API calls to Netlify Functions (for MODE 1 - Full-Stack)
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200
  force = false

# Handle Next.js dynamic routes
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# ------------------------------------------------------------------------------
# Security Headers
# ------------------------------------------------------------------------------
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"

# ------------------------------------------------------------------------------
# Caching Headers
# ------------------------------------------------------------------------------
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# ------------------------------------------------------------------------------
# Context-Specific Builds
# ------------------------------------------------------------------------------

# Deploy previews (PR builds)
[context.deploy-preview]
  command = """
    pnpm install &&
    cd packages/shared && pnpm build &&
    cd ../backend && pnpm build &&
    cd ../frontend && pnpm build
  """

# Branch deploys
[context.branch-deploy]
  command = """
    pnpm install &&
    cd packages/shared && pnpm build &&
    cd ../backend && pnpm build &&
    cd ../frontend && pnpm build
  """

# Production context
[context.production]
  command = """
    pnpm install &&
    cd packages/shared && pnpm build &&
    cd ../backend && pnpm build &&
    cd ../frontend && pnpm build
  """

# ------------------------------------------------------------------------------
# Netlify Next.js Plugin (required for Next.js deployment)
# ------------------------------------------------------------------------------
[[plugins]]
  package = "@netlify/plugin-nextjs"

# ------------------------------------------------------------------------------
# Optional Plugins (uncomment to enable)
# ------------------------------------------------------------------------------
# [[plugins]]
#   package = "netlify-plugin-cache-nextjs"
#
# [[plugins]]
#   package = "@netlify/plugin-lighthouse"

