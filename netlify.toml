# Netlify Configuration for Compliant Platform (Full-Stack)
# Documentation: https://docs.netlify.com/configure-builds/file-based-configuration/

# ==============================================================================
# DEPLOYMENT MODE - CHOOSE ONE:
# ==============================================================================
# MODE 1: Full-Stack (Frontend + Backend on Netlify Functions)
# - Uncomment the [build] section below with "Full-Stack Build"
# - Backend runs as Netlify Functions with 10s timeout (free tier)
# - Best for: Simple APIs, low traffic, serverless architecture
#
# MODE 2: Frontend Only (Backend hosted elsewhere)
# - Use the commented "Frontend Only Build" section
# - Backend hosted on Render, Railway, Fly.io, etc.
# - Best for: Complex APIs, long-running operations, high traffic
# ==============================================================================

# ------------------------------------------------------------------------------
# MODE 1: Full-Stack Build (Frontend + Backend on Netlify)
# ------------------------------------------------------------------------------
[build]
  base = "packages/frontend"
  # Build shared package, backend, and frontend
  # Netlify will bundle the function with node_bundler = "esbuild"
  command = """
    cd ../../ && pnpm install &&
    cd packages/shared && pnpm install && pnpm build &&
    cd ../backend && pnpm install && pnpm build &&
    cd ../frontend && pnpm install && pnpm build &&
    cd ../../netlify/functions && pnpm install
  """
  publish = ".next"
  functions = "../../netlify/functions"

# ------------------------------------------------------------------------------
# MODE 2: Frontend Only Build (Uncomment to use)
# ------------------------------------------------------------------------------
# [build]
#   base = "packages/frontend"
#   command = "cd ../shared && pnpm install && pnpm build && cd ../frontend && pnpm install && pnpm build"
#   publish = "packages/frontend/.next"

[build.environment]
  # Node.js version
  NODE_VERSION = "20.0.0"
  
  # PNPM version
  PNPM_VERSION = "8.15.0"
  
  # Important: Set environment variables in Netlify Dashboard UI
  # Site settings -> Build & deploy -> Environment variables
  #
  # For Full-Stack Mode (MODE 1):
  # - NEXT_PUBLIC_API_URL = "/.netlify/functions/api"
  # - DATABASE_URL = "postgresql://..."
  # - JWT_SECRET = "your-secret-min-32-chars"
  # - JWT_REFRESH_SECRET = "your-refresh-secret"
  # - FRONTEND_URL = "https://your-site.netlify.app"
  #
  # For Frontend Only Mode (MODE 2):
  # - NEXT_PUBLIC_API_URL = "https://your-backend-api.com/api"

# ------------------------------------------------------------------------------
# Netlify Functions Configuration
# ------------------------------------------------------------------------------
[functions]
  # Use esbuild to bundle the function with all dependencies
  node_bundler = "esbuild"
  # Include backend dist files (needed for NestJS app) and Prisma schema
  included_files = [
    "../backend/dist/**",
    "../backend/prisma/**",
    "../shared/dist/**"
  ]
  # Mark ALL node modules as external so they're installed but not bundled
  # This allows pre-compiled backend code to require them
  external_node_modules = ["*"]

# ------------------------------------------------------------------------------
# Redirects and Rewrites
# ------------------------------------------------------------------------------

# Redirect API calls to Netlify Functions (for MODE 1 - Full-Stack)
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200
  force = false

# Handle Next.js dynamic routes
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# ------------------------------------------------------------------------------
# Security Headers
# ------------------------------------------------------------------------------
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"

# ------------------------------------------------------------------------------
# Caching Headers
# ------------------------------------------------------------------------------
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# ------------------------------------------------------------------------------
# Context-Specific Builds
# ------------------------------------------------------------------------------

# Deploy previews (PR builds)
[context.deploy-preview]
  command = """
    cd ../../ && pnpm install &&
    cd packages/shared && pnpm install && pnpm build &&
    cd ../backend && pnpm install && pnpm build &&
    cd ../frontend && pnpm install && pnpm build &&
    cd ../../netlify/functions && pnpm install
  """

# Branch deploys
[context.branch-deploy]
  command = """
    cd ../../ && pnpm install &&
    cd packages/shared && pnpm install && pnpm build &&
    cd ../backend && pnpm install && pnpm build &&
    cd ../frontend && pnpm install && pnpm build &&
    cd ../../netlify/functions && pnpm install
  """

# Production context
[context.production]
  command = """
    cd ../../ && pnpm install &&
    cd packages/shared && pnpm install && pnpm build &&
    cd ../backend && pnpm install && pnpm build &&
    cd ../frontend && pnpm install && pnpm build &&
    cd ../../netlify/functions && pnpm install
  """

# ------------------------------------------------------------------------------
# Optional Plugins (uncomment to enable)
# ------------------------------------------------------------------------------
# [[plugins]]
#   package = "netlify-plugin-cache-nextjs"
#
# [[plugins]]
#   package = "@netlify/plugin-lighthouse"

